name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  PYTHONWARNINGS: default
  MPLBACKEND: Agg
  QT_QPA_PLATFORM: offscreen

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - name: Install lint deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff mypy
      - name: Ruff
        run: ruff check src tests
      - name: Mypy (core)
        run: >
          mypy --ignore-missing-imports --follow-imports=skip
          src/phage_annotator/io.py
          src/phage_annotator/analysis.py
          src/phage_annotator/annotations.py
          src/phage_annotator/project_io.py
          src/phage_annotator/projection_cache.py
          src/phage_annotator/pyramid.py
          src/phage_annotator/ring_buffer.py
      - name: Core Qt import guard
        run: python scripts/check_core_no_qt.py

  test-core:
    name: Core Tests (${{ matrix.os }} / py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Prepare artifacts dir
        run: python -c "import pathlib; pathlib.Path('artifacts').mkdir(exist_ok=True)"
      - name: Diagnostics
        run: |
          python -c "import sys,platform; print(sys.version); print(platform.platform())"
          python -c "import matplotlib; print('matplotlib', matplotlib.get_backend())"
          python -c "import pkgutil; print('PyQt5', 'available' if pkgutil.find_loader('PyQt5') else 'not available')"
      - name: Run core tests
        run: >
          python -m pytest -m "not gui" --ignore=tests/test_gui_basic.py
          --junitxml=artifacts/junit-core.xml
          --log-file=artifacts/pytest-core.log
          --durations=10
      - name: Upload core artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: core-artifacts-${{ matrix.os }}-py${{ matrix.python-version }}
          path: artifacts

  test-gui:
    name: GUI Tests (${{ matrix.os }} / py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest, macos-latest]
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev]
      - name: Prepare artifacts dir
        run: python -c "import pathlib; pathlib.Path('artifacts').mkdir(exist_ok=True)"
      - name: Install Xvfb (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      - name: Diagnostics
        run: |
          python -c "import sys,platform; print(sys.version); print(platform.platform())"
          python -c "import matplotlib; print('matplotlib', matplotlib.get_backend())"
          python -c "import pkgutil; print('PyQt5', 'available' if pkgutil.find_loader('PyQt5') else 'not available')"
      - name: Run GUI tests (Linux)
        if: runner.os == 'Linux'
        env:
          QT_QPA_PLATFORM: offscreen
          MPLBACKEND: Agg
        run: >
          xvfb-run -a python -m pytest -m gui --run-gui
          --junitxml=artifacts/junit-gui.xml
          --log-file=artifacts/pytest-gui.log
          --durations=10
      - name: Run GUI tests (macOS/Windows)
        if: runner.os != 'Linux'
        env:
          QT_QPA_PLATFORM: offscreen
          MPLBACKEND: Agg
        run: >
          python -m pytest -m gui --run-gui
          --junitxml=artifacts/junit-gui.xml
          --log-file=artifacts/pytest-gui.log
          --durations=10
      - name: Upload GUI artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gui-artifacts-${{ matrix.os }}-py${{ matrix.python-version }}
          path: artifacts

  build:
    name: Build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - name: Build sdist/wheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build
      - name: Smoke-test wheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python - <<'PY'
          import phage_annotator
          from phage_annotator import io, annotations
          print("import ok", phage_annotator.__version__)
          print("io", io.__name__, "annotations", annotations.__name__)
          PY
